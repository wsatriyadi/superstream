<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/favicon.png">
  <title><%= title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/custom.css">
</head>
<body>
  <% 
    const activePage = 'settings';
    const pageTitle = 'Settings';
  %>

  <%- include('partials/sidebar', { activePage }) %>

  <div class="main-content">
    <%- include('partials/topbar', { pageTitle, user }) %>

    <div class="content-container">
      <div class="row">
        <div class="col-lg-8 mx-auto">
          <% if (messages && messages.success && messages.success.length > 0) { %>
            <div class="alert alert-success alert-dismissible fade show" role="alert">
              <i class="bi bi-check-circle-fill me-2"></i>
              <%= messages.success %>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          <% } %>

          <% if (messages && messages.error && messages.error.length > 0) { %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              <%= messages.error %>
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
          <% } %>

          <!-- Google API Credentials Card -->
          <div class="card shadow-sm mb-4" style="border-radius: 16px; border: none;">
            <div class="card-body" style="padding: 30px;">
              <div class="d-flex align-items-center mb-4">
                <div class="stat-icon primary me-3">
                  <i class="bi bi-key"></i>
                </div>
                <div>
                  <h4 class="mb-1" style="font-weight: 700; color: var(--dark-bg);">Google API Credentials</h4>
                  <p class="text-muted mb-0" style="font-size: 14px;">Configure YouTube API access</p>
                </div>
              </div>

              <form method="POST" action="/settings" id="settingsForm">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                
                <div class="mb-4">
                  <label for="googleClientId" class="form-label">
                    Client ID <span class="text-danger">*</span>
                  </label>
                  <input 
                    type="text" 
                    class="form-control" 
                    id="googleClientId" 
                    name="googleClientId"
                    value="<%= settings.googleClientId || '' %>"
                    placeholder="123456789-abcdefg.apps.googleusercontent.com"
                  >
                  <div class="form-text">
                    <i class="bi bi-info-circle"></i> Format: xxxxx.apps.googleusercontent.com
                  </div>
                </div>

                <div class="mb-4">
                  <label for="googleClientSecret" class="form-label">
                    Client Secret <span class="text-danger">*</span>
                  </label>
                  <div class="input-group">
                    <input 
                      type="password" 
                      class="form-control" 
                      id="googleClientSecret" 
                      name="googleClientSecret"
                      value="<%= settings.googleClientSecret || '' %>"
                      placeholder="Enter your Google Client Secret"
                      minlength="20"
                    >
                    <button class="btn btn-outline-secondary" type="button" onclick="togglePassword()">
                      <i class="bi bi-eye" id="toggleIcon"></i>
                    </button>
                  </div>
                  <div class="form-text">
                    <i class="bi bi-info-circle"></i> Minimum 20 characters
                  </div>
                </div>

                <div class="mb-4">
                  <label for="googleRedirectUri" class="form-label">
                    <i class="bi bi-arrow-return-left"></i>
                    Google Redirect URI
                  </label>
                  <input 
                    type="url" 
                    class="form-control" 
                    id="googleRedirectUri" 
                    name="googleRedirectUri"
                    value="<%= settings.googleRedirectUri || '' %>"
                    placeholder="http://localhost:3000/channels/oauth/callback"
                  >
                  <div class="form-text">
                    <i class="bi bi-info-circle"></i> OAuth redirect URI (must match Google Cloud Console)
                  </div>
                </div>

                <hr class="my-4">

                <div class="d-flex align-items-center mb-4">
                  <div class="stat-icon info me-3">
                    <i class="bi bi-sliders"></i>
                  </div>
                  <div>
                    <h5 class="mb-1" style="font-weight: 600; color: var(--dark-bg);">Application Settings</h5>
                    <p class="text-muted mb-0" style="font-size: 14px;">Configure scheduler and upload limits</p>
                  </div>
                </div>

                <div class="row g-3 mb-4">
                  <div class="col-md-6">
                    <label for="schedulerInterval" class="form-label">
                      Scheduler Interval (minutes)
                    </label>
                    <input 
                      type="number" 
                      class="form-control" 
                      id="schedulerInterval" 
                      name="schedulerInterval"
                      value="<%= settings.schedulerInterval || 5 %>"
                      min="1"
                      max="60"
                    >
                    <div class="form-text">
                      How often streams are scheduled (1-60 min)
                    </div>
                  </div>

                  <div class="col-md-6">
                    <label for="maxUploadSize" class="form-label">
                      Max Upload Size (GB)
                    </label>
                    <input 
                      type="number" 
                      class="form-control" 
                      id="maxUploadSizeGB" 
                      value="<%= Math.round((settings.maxUploadSize || 5368709120) / 1073741824) %>"
                      min="1"
                      max="150"
                      step="0.5"
                    >
                    <input type="hidden" id="maxUploadSize" name="maxUploadSize" value="<%= settings.maxUploadSize || 5368709120 %>">
                    <div class="form-text">
                      Maximum video file size (1-150 GB)
                    </div>
                  </div>
                </div>

                <div class="d-grid">
                  <button type="submit" class="btn btn-primary btn-lg">
                    <i class="bi bi-save"></i> Save Settings
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Setup Instructions Card -->
          <div class="card shadow-sm" style="border-radius: 16px; border: none; background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));">
            <div class="card-body" style="padding: 30px;">
              <div class="d-flex align-items-center mb-3">
                <div class="stat-icon primary me-3">
                  <i class="bi bi-lightbulb"></i>
                </div>
                <h5 class="mb-0" style="font-weight: 600; color: var(--dark-bg);">Setup Instructions</h5>
              </div>
              <ol class="mb-0" style="padding-left: 20px;">
                <li class="mb-2">Go to <a href="https://console.cloud.google.com/" target="_blank" class="text-primary">Google Cloud Console</a></li>
                <li class="mb-2">Create a new project or select an existing one</li>
                <li class="mb-2">Enable <strong>YouTube Data API v3</strong> and <strong>YouTube Live Streaming API</strong></li>
                <li class="mb-2">Create OAuth 2.0 credentials (Web application type)</li>
                <li class="mb-2">Add authorized redirect URI: <code style="background: white; padding: 4px 8px; border-radius: 6px;">http://localhost:3000/channels/oauth/callback</code></li>
                <li>Copy the Client ID and Client Secret and paste them above</li>
              </ol>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Convert GB to bytes
    document.getElementById('maxUploadSizeGB').addEventListener('input', function() {
      const gb = parseFloat(this.value) || 5;
      const bytes = Math.round(gb * 1073741824);
      document.getElementById('maxUploadSize').value = bytes;
    });

    // Toggle password visibility
    function togglePassword() {
      const input = document.getElementById('googleClientSecret');
      const icon = document.getElementById('toggleIcon');
      if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
      } else {
        input.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
      }
    }

    // Form validation
    document.getElementById('settingsForm').addEventListener('submit', function(e) {
      const form = e.target;
      const clientId = document.getElementById('googleClientId').value.trim();
      const clientSecret = document.getElementById('googleClientSecret').value.trim();
      
      if (clientId && !clientId.includes('.apps.googleusercontent.com')) {
        e.preventDefault();
        alert('Invalid Google Client ID format. Must end with .apps.googleusercontent.com');
        return false;
      }
      
      if (clientSecret && clientSecret.length < 20) {
        e.preventDefault();
        alert('Google Client Secret must be at least 20 characters long');
        return false;
      }

      // Show loading state
      const btn = form.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
    });
  </script>
  <%- include('partials/footer') %>
</body>
</html>
