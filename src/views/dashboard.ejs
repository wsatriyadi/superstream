<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/favicon.png">
  <title><%= title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/custom.css">
</head>
<body>
  <% 
    const activePage = 'dashboard';
    const pageTitle = 'Dashboard';
    
    // Ensure systemStats has default values
    const safeSystemStats = (typeof systemStats !== 'undefined' ? systemStats : null) || {
      cpu: { usage: 0, cores: 0 },
      memory: { usagePercent: 0, totalGB: '0', usedGB: '0' },
      disk: { usagePercent: 0, totalGB: '0', usedGB: '0' },
      network: { interfaces: [], hostname: 'Unknown' }
    };
    
    const formatNumber = (num) => {
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toString();
    };
    
    const formatWatchTime = (seconds) => {
      if (!seconds) return '0h';
      const hours = Math.floor(seconds / 3600);
      if (hours >= 1000) return formatNumber(hours) + 'h';
      return hours + 'h';
    };
  %>

  <%- include('partials/sidebar', { activePage }) %>

  <div class="main-content">
    <%- include('partials/topbar', { pageTitle, user }) %>

    <div class="content-container">
      <!-- Stats Cards -->
      <div class="row g-4 mb-4">
        <div class="col-xl-3 col-md-6">
          <div class="stat-card card shadow-sm fade-in">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="stat-label">Total Channels</div>
                  <div class="stat-value"><%= stats.totalChannels %></div>
                  <div class="mt-2">
                    <small class="text-success">
                      <i class="bi bi-arrow-up"></i> Active
                    </small>
                  </div>
                </div>
                <div class="stat-icon primary">
                  <i class="bi bi-collection-play"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-md-6">
          <div class="stat-card card shadow-sm fade-in" style="animation-delay: 0.1s">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="stat-label">Total Subscribers</div>
                  <div class="stat-value"><%= formatNumber(stats.totalSubscribers) %></div>
                  <div class="mt-2">
                    <small class="text-muted">
                      Across all channels
                    </small>
                  </div>
                </div>
                <div class="stat-icon success">
                  <i class="bi bi-people-fill"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-md-6">
          <div class="stat-card card shadow-sm fade-in" style="animation-delay: 0.2s">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="stat-label">Total Views</div>
                  <div class="stat-value"><%= formatNumber(stats.totalViews) %></div>
                  <div class="mt-2">
                    <small class="text-muted">
                      Lifetime views
                    </small>
                  </div>
                </div>
                <div class="stat-icon info">
                  <i class="bi bi-eye-fill"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-md-6">
          <div class="stat-card card shadow-sm fade-in" style="animation-delay: 0.3s">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="stat-label">Active Streams</div>
                  <div class="stat-value"><%= stats.totalActiveStreams %></div>
                  <div class="mt-2">
                    <% if (stats.totalActiveStreams > 0) { %>
                      <small class="text-danger">
                        <i class="bi bi-circle-fill" style="font-size: 8px;"></i> Live now
                      </small>
                    <% } else { %>
                      <small class="text-muted">
                        No active streams
                      </small>
                    <% } %>
                  </div>
                </div>
                <div class="stat-icon danger">
                  <i class="bi bi-broadcast-pin"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- System Resources -->
      <div class="row g-4 mb-4">
        <div class="col-12">
          <h5 class="mb-3" style="font-weight: 700; color: var(--dark-bg);">
            <i class="bi bi-cpu text-primary"></i> System Resources
          </h5>
        </div>

        <div class="col-xl-3 col-md-6">
          <div class="card shadow-sm fade-in" style="border-radius: 16px; border: none; animation-delay: 0.4s;">
            <div class="card-body" style="padding: 20px;">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="stat-label">CPU Usage</div>
                <i class="bi bi-cpu" style="font-size: 24px; color: var(--primary-color);"></i>
              </div>
              <div class="mb-2">
                <h3 class="mb-0" style="font-weight: 700; color: var(--dark-bg);"><%= safeSystemStats.cpu.usage %>%</h3>
              </div>
              <div class="progress" style="height: 8px; border-radius: 10px;">
                <div class="progress-bar" role="progressbar" 
                     style="width: <%= safeSystemStats.cpu.usage %>%; background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));"
                     aria-valuenow="<%= safeSystemStats.cpu.usage %>" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="text-muted mt-2 d-block"><%= safeSystemStats.cpu.cores %> cores</small>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-md-6">
          <div class="card shadow-sm fade-in" style="border-radius: 16px; border: none; animation-delay: 0.5s;">
            <div class="card-body" style="padding: 20px;">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="stat-label">Memory</div>
                <i class="bi bi-memory" style="font-size: 24px; color: var(--success-color);"></i>
              </div>
              <div class="mb-2">
                <h3 class="mb-0" style="font-weight: 700; color: var(--dark-bg);"><%= safeSystemStats.memory.usagePercent %>%</h3>
              </div>
              <div class="progress" style="height: 8px; border-radius: 10px;">
                <div class="progress-bar bg-success" role="progressbar" 
                     style="width: <%= safeSystemStats.memory.usagePercent %>%;"
                     aria-valuenow="<%= safeSystemStats.memory.usagePercent %>" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="text-muted mt-2 d-block"><%= safeSystemStats.memory.usedGB %> / <%= safeSystemStats.memory.totalGB %> GB</small>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-md-6">
          <div class="card shadow-sm fade-in" style="border-radius: 16px; border: none; animation-delay: 0.6s;">
            <div class="card-body" style="padding: 20px;">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="stat-label">Disk Usage</div>
                <i class="bi bi-hdd" style="font-size: 24px; color: var(--info-color);"></i>
              </div>
              <div class="mb-2">
                <h3 class="mb-0" style="font-weight: 700; color: var(--dark-bg);"><%= safeSystemStats.disk.usagePercent %>%</h3>
              </div>
              <div class="progress" style="height: 8px; border-radius: 10px;">
                <div class="progress-bar bg-info" role="progressbar" 
                     style="width: <%= safeSystemStats.disk.usagePercent %>%;"
                     aria-valuenow="<%= safeSystemStats.disk.usagePercent %>" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <small class="text-muted mt-2 d-block"><%= safeSystemStats.disk.usedGB %> / <%= safeSystemStats.disk.totalGB %> GB</small>
            </div>
          </div>
        </div>

        <div class="col-xl-3 col-md-6">
          <div class="card shadow-sm fade-in" style="border-radius: 16px; border: none; animation-delay: 0.7s;">
            <div class="card-body" style="padding: 20px;">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="stat-label">Network</div>
                <i class="bi bi-wifi" style="font-size: 24px; color: var(--warning-color);"></i>
              </div>
              <div class="mb-2">
                <h3 class="mb-0" style="font-weight: 700; color: var(--dark-bg); font-size: 18px;">
                  <%= safeSystemStats.network.interfaces.length %> Active
                </h3>
              </div>
              <small class="text-muted d-block" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                <i class="bi bi-hdd-network"></i> <%= safeSystemStats.network.hostname %>
              </small>
              <% if (safeSystemStats.network.interfaces.length > 0) { %>
                <small class="text-muted d-block mt-1" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                  <%= safeSystemStats.network.interfaces[0].address %>
                </small>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <!-- Channels List -->
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm" style="border-radius: 16px; border: none;">
            <div class="card-body" style="padding: 24px;">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                  <h4 class="mb-1" style="font-weight: 700; color: var(--dark-bg);">
                    <i class="bi bi-collection-play text-primary"></i> Connected Channels
                  </h4>
                  <p class="text-muted mb-0" style="font-size: 14px;">Manage your YouTube channels</p>
                </div>
                <a href="/channels" class="btn btn-primary">
                  <i class="bi bi-plus-circle"></i> Add Channel
                </a>
              </div>

              <% if (channels.length === 0) { %>
                <div class="empty-state">
                  <div class="empty-state-icon">
                    <i class="bi bi-collection-play"></i>
                  </div>
                  <h3 class="empty-state-title">No channels connected yet</h3>
                  <p class="empty-state-text">Connect your first YouTube channel to start streaming</p>
                  <a href="/channels/connect" class="btn btn-primary btn-lg">
                    <i class="bi bi-plus-circle"></i> Connect Channel
                  </a>
                </div>
              <% } else { %>
                <div class="table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>Channel</th>
                        <th class="text-end">Subscribers</th>
                        <th class="text-end">Total Views</th>
                        <th class="text-end">Watch Time</th>
                        <th class="text-end">Status</th>
                        <th class="text-end">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% channels.forEach(channel => { %>
                        <tr>
                          <td>
                            <div class="d-flex align-items-center gap-3">
                              <% if (channel.thumbnailUrl) { %>
                                <img src="<%= channel.thumbnailUrl %>" 
                                     alt="<%= channel.channelName %>" 
                                     class="rounded-circle"
                                     width="48" height="48"
                                     style="object-fit: cover;">
                              <% } else { %>
                                <div class="rounded-circle bg-gradient d-flex align-items-center justify-content-center" 
                                     style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));">
                                  <i class="bi bi-person-fill text-white fs-5"></i>
                                </div>
                              <% } %>
                              <div>
                                <div style="font-weight: 600; color: var(--dark-bg);"><%= channel.channelName %></div>
                                <small class="text-muted"><%= channel.channelId %></small>
                              </div>
                            </div>
                          </td>
                          <td class="text-end">
                            <strong style="color: var(--dark-bg);"><%= formatNumber(channel.subscriberCount || 0) %></strong>
                          </td>
                          <td class="text-end">
                            <strong style="color: var(--dark-bg);"><%= formatNumber(channel.totalViews || 0) %></strong>
                          </td>
                          <td class="text-end">
                            <strong style="color: var(--dark-bg);"><%= formatWatchTime(channel.totalWatchTime || 0) %></strong>
                          </td>
                          <td class="text-end">
                            <% if (channel.activeStreamCount > 0) { %>
                              <span class="badge bg-danger">
                                <i class="bi bi-broadcast"></i> <%= channel.activeStreamCount %> Live
                              </span>
                            <% } else { %>
                              <span class="badge bg-secondary">Idle</span>
                            <% } %>
                          </td>
                          <td class="text-end">
                            <a href="/channels" class="btn btn-sm btn-outline-primary">
                              <i class="bi bi-gear"></i> Manage
                            </a>
                          </td>
                        </tr>
                      <% }); %>
                    </tbody>
                  </table>
                </div>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <%- include('partials/footer') %>
</body>
</html>
