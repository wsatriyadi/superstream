require('dotenv').config();

const express = require('express');
const session = require('express-session');
const passport = require('./config/passport');
const path = require('path');
const flash = require('connect-flash');
const helmet = require('helmet');
const logger = require('./config/logger');
const connectDatabase = require('./config/database');
const streamScheduler = require('./services/streamScheduler');
const { errorHandler, notFoundHandler } = require('./middleware/errorHandler');
const {
  sanitizeInput,
  csrfProtection,
  addCsrfToken,
  csrfErrorHandler,
} = require('./middleware/security');

const app = express();
const PORT = process.env.PORT || 3000;

// Track if database is connected
let isDatabaseConnected = false;

// Security middleware - helmet for security headers
app.use(
  helmet({
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"],
        styleSrc: ["'self'", "'unsafe-inline'", 'https://cdn.jsdelivr.net'],
        scriptSrc: ["'self'", "'unsafe-inline'", 'https://cdn.jsdelivr.net'],
        imgSrc: ["'self'", 'data:', 'https:'],
        connectSrc: ["'self'"],
        fontSrc: ["'self'", 'https://cdn.jsdelivr.net'],
        objectSrc: ["'none'"],
        mediaSrc: ["'self'"],
        frameSrc: ["'none'"],
      },
    },
    hsts: {
      maxAge: 31536000, // 1 year
      includeSubDomains: true,
      preload: true,
    },
    noSniff: true,
    xssFilter: true,
    referrerPolicy: { policy: 'strict-origin-when-cross-origin' },
  })
);

// View engine setup
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));

// Body parser middleware
app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));
app.use(express.static(path.join(__dirname, '../public')));
app.use('/uploads', express.static(path.join(__dirname, '../uploads')));

// Input sanitization middleware - apply to all requests
app.use(sanitizeInput);

// Session configuration
app.use(
  session({
    secret: process.env.SESSION_SECRET || 'super-stream-secret-key-change-in-production',
    resave: false,
    saveUninitialized: false,
    cookie: {
      secure: process.env.NODE_ENV === 'production',
      httpOnly: true,
      maxAge: 24 * 60 * 60 * 1000, // 24 hours
    },
  })
);

// Flash messages
app.use(flash());

// Initialize Passport
app.use(passport.initialize());
app.use(passport.session());

// CSRF Protection - apply to all routes except API GET requests
app.use(csrfProtection);
app.use(addCsrfToken);

// Make user available in all views
app.use((req, res, next) => {
  res.locals.user = req.user;
  res.locals.messages = {
    error: req.flash('error'),
    success: req.flash('success'),
    info: req.flash('info'),
  };
  next();
});

// Serve favicon
app.get('/favicon.ico', (req, res) => {
  res.sendFile(path.join(__dirname, '../public/favicon.png'));
});

// Setup check middleware - redirect to setup if no users exist
const checkSetup = require('./middleware/setupCheck');
app.use(checkSetup);

// Routes
const setupRoutes = require('./routes/setup');
const authRoutes = require('./routes/auth');
const channelRoutes = require('./routes/channels');
const videoRoutes = require('./routes/videos');
const streamRoutes = require('./routes/streams');
const settingsRoutes = require('./routes/settings');

app.use('/', setupRoutes);
app.use('/', authRoutes);
app.use('/', channelRoutes);
app.use('/', videoRoutes);
app.use('/', streamRoutes);
app.use('/', settingsRoutes);

// Basic route for testing
app.get('/', (req, res) => {
  if (req.isAuthenticated()) {
    res.redirect('/dashboard');
  } else {
    res.redirect('/login');
  }
});

// 404 handler - must be after all routes
app.use(notFoundHandler);

// CSRF error handler - must be before general error handler
app.use(csrfErrorHandler);

// Error handling middleware - must be last
app.use(errorHandler);

/**
 * Initialize the application
 * Connects to database and starts the scheduler
 */
async function initializeApp() {
  try {
    // Connect to MongoDB
    logger.info('Initializing application...');
    await connectDatabase();
    isDatabaseConnected = true;
    logger.info('Database connection established');

    // Start the stream scheduler with settings from database
    const Settings = require('./models/Settings');
    const settings = await Settings.getSettings();
    const schedulerInterval = settings.schedulerInterval || 5;
    const cronExpression = `*/${schedulerInterval} * * * *`;
    streamScheduler.start(cronExpression);
    logger.info(`Stream scheduler started with interval: ${schedulerInterval} minutes`);

    logger.info('Application initialized successfully');
  } catch (error) {
    logger.error('Failed to initialize application', {
      error: error.message,
      stack: error.stack,
    });
    throw error;
  }
}

/**
 * Graceful shutdown handler
 * Stops scheduler and closes database connection
 */
async function gracefulShutdown(signal) {
  logger.info(`${signal} received, starting graceful shutdown...`);

  try {
    // Stop the scheduler
    if (streamScheduler) {
      logger.info('Stopping stream scheduler...');
      streamScheduler.stop();
      logger.info('Stream scheduler stopped');
    }

    // Close database connection
    if (isDatabaseConnected) {
      logger.info('Closing database connection...');
      const mongoose = require('mongoose');
      await mongoose.connection.close();
      logger.info('Database connection closed');
    }

    logger.info('Graceful shutdown completed');
    process.exit(0);
  } catch (error) {
    logger.error('Error during graceful shutdown', {
      error: error.message,
      stack: error.stack,
    });
    process.exit(1);
  }
}

// Register shutdown handlers
process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
process.on('SIGINT', () => gracefulShutdown('SIGINT'));

// Handle uncaught exceptions
process.on('uncaughtException', (error) => {
  logger.error('Uncaught Exception', {
    error: error.message,
    stack: error.stack,
  });
  gracefulShutdown('uncaughtException');
});

// Handle unhandled promise rejections
process.on('unhandledRejection', (reason, promise) => {
  logger.error('Unhandled Rejection', {
    reason: reason,
    promise: promise,
  });
});

// Start server
if (require.main === module) {
  initializeApp()
    .then(() => {
      app.listen(PORT, () => {
        logger.info(`Server is running on port ${PORT}`);
        logger.info(`Environment: ${process.env.NODE_ENV || 'development'}`);
        logger.info(`Process ID: ${process.pid}`);
      });
    })
    .catch((error) => {
      logger.error('Failed to start application', {
        error: error.message,
        stack: error.stack,
      });
      process.exit(1);
    });
}

module.exports = app;
